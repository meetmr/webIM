<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login WebIM</title>
    <meta name="description" content="">
    <meta name="author" content="templatemo">
    <link href="favicon.ico" type="image/vnd.microsoft.icon" rel="shortcut icon"/>
    <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/templatemo-style.css" rel="stylesheet">
    <link href="/static/layui/dist/css/layui.css" rel="stylesheet">
</head>
<body class="light-gray-bg">
<div class="templatemo-content-widget templatemo-login-widget white-bg tp-8">
</div>
</body>
<script type="text/javascript" src="/static/layui/dist/layui.js"></script>
<script>
    var  uid = "{$Think.session.user.id}";
    var socket = new WebSocket('ws://127.0.0.1:8282');
    let layimy = null;

    socket.onopen = function(){
        layui.use('layim', function(layim){
            layimy = layim;
            // 绑定uid
            socket.send(JSON.stringify({
                type: 'reg' //随便定义，用于在服务端区分消息类型
                ,data: {'uid':uid}
            }));

            layim.config({
                init: {
                    url:  "{:url('index/Index/iniHomepage')}" //接口地址（返回的数据格式见下文）
                    ,type: 'get' //默认get，一般可不填
                    ,data: {} //额外参数
                } //获取主面板列表信息，下文会做进一步介绍

                //获取群员接口（返回的数据格式见下文）
                ,members: {
                    url: '' //接口地址（返回的数据格式见下文）
                    ,type: 'get' //默认get，一般可不填
                    ,data: {} //额外参数
                }

                //上传图片接口（返回的数据格式见下文），若不开启图片上传，剔除该项即可
                ,uploadImage: {
                    url: '' //接口地址
                    ,type: 'post' //默认post
                }

                //上传文件接口（返回的数据格式见下文），若不开启文件上传，剔除该项即可
                ,uploadFile: {
                    url: '' //接口地址
                    ,type: 'post' //默认post
                }
                //扩展工具栏，下文会做进一步介绍（如果无需扩展，剔除该项即可）
                ,tool: [{
                    alias: 'code' //工具别名
                    ,title: '代码' //工具名称
                    ,icon: '&#xe64e;' //工具图标，参考图标文档
                }]
                ,title: 'WebIm' //自定义主面板最小化时的标题
                //,right: '100px' //主面板相对浏览器右侧距离
                ,minRight: '90px' //聊天面板最小化时相对浏览器右侧距离
                ,initSkin: '3.jpg' //1-5 设置初始背景
                ,skin: ['aaa.jpg'] //新增皮肤
                ,min:false //是否始终最小化主面板，默认false
                ,notice: true //是否开启桌面消息提醒，默认false
                ,isAudio: true //开启聊天工具栏音频
                ,isVideo: true //开启聊天工具栏视频
                ,msgbox: layui.cache.dir + 'css/modules/layim/html/msgbox.html' //消息盒子页面地址，若不开启，剔除该项即可
                ,find: layui.cache.dir + 'css/modules/layim/html/find.html' //发现页面地址，若不开启，剔除该项即可
                ,chatLog: layui.cache.dir + 'css/modules/layim/html/chatlog.html' //聊天记录页面地址，若不开启，剔除该项即可

            });
            localStorage.clear();
            // 监听发送消息
            layim.on('sendMessage', function(res){
                socket.send(JSON.stringify({
                    type: 'chatMessage' //随便定义，用于在服务端区分消息类型
                    ,data: res
                }));
            });

            //监听在线状态的切换事件
            layim.on('online', function(status){
                layer.msg(status);
            });

            // 聊天窗口切换
            layim.on('chatChange', function (res) {
                // 获取聊天记录，res.data.id 是ID
                console.log(res);
                webIm.getChatRecord(res.data.id);
            });

            // 监听到消息
            socket.onmessage = function(res){
                res = JSON.parse(res.data);
                if(res.emit === 'chatMessage'){
                    console.log(res.data);
                    layim.getMessage(res.data); //res.data即你发送消息传递的数据（阅读：监听发送的消息）
                }
            };

        })
    };


var webIm = {
    getChatRecord:function (uid) {

        // layimy.getMessage({
        //     username: "专家答疑" //消息来源用户名
        //     ,avatar: "http://tp1.sinaimg.cn/1571889140/180/40030060651/1" //消息来源用户头像
        //     ,id: uid//消息的来源ID（如果是私聊，则是用户id，如果是群聊，则是群组id）
        //     ,type: "friend" //聊天窗口来源类型，从发送消息传递的to里面获取
        //     ,content:'121212' //消息内容
        //     ,cid: 121 //消息id，可不传。除非你要对消息进行一些操作（如撤回）
        //     ,mine: false //是否我发送的消息，如果为true，则会显示在右方
        //     ,fromid:2 //消息的发送者id（比如群组中的某个消息发送者），可用于自动解决浏览器多窗口时的一些问题
        //     ,timestamp: 12156565656 * 1000 //服务端时间戳毫秒数。注意：如果你返回的是标准的 unix 时间戳，记得要 *1000
        // });
    }
}

</script>
</html>